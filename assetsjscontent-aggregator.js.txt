// Content Aggregation System
class ContentAggregator {
    constructor() {
        this.apiKey = 'YOUR_NEWS_API_KEY'; // Get from newsapi.org
        this.rssFeeds = [
            'https://www.technologyreview.com/feed/',
            'https://blog.google/technology/ai/rss/',
            'https://openai.com/blog/rss.xml',
            'https://blogs.microsoft.com/ai/feed/',
            'https://techcrunch.com/category/artificial-intelligence/feed/',
            'https://venturebeat.com/ai/feed/',
            'https://www.wired.com/feed/tag/ai/latest/rss',
            'https://www.theverge.com/ai-artificial-intelligence/rss/index.xml'
        ];
        
        this.apiSources = [
            'technologyreview.com',
            'techcrunch.com',
            'venturebeat.com',
            'wired.com',
            'theverge.com',
            'arstechnica.com',
            'spectrum.ieee.org',
            'blog.google',
            'openai.com',
            'blogs.microsoft.com'
        ];
        
        this.lastUpdate = localStorage.getItem('lastNewsUpdate');
        this.cachedNews = JSON.parse(localStorage.getItem('cachedNews') || '[]');
    }

    // Fetch content from multiple sources
    async fetchAllContent() {
        try {
            showLoadingState();
            
            const [newsApiData, redditData, hackerNewsData] = await Promise.all([
                this.fetchFromNewsAPI(),
                this.fetchFromReddit(),
                this.fetchFromHackerNews()
            ]);

            const allArticles = [
                ...newsApiData,
                ...redditData,
                ...hackerNewsData
            ];

            // Remove duplicates and sort by date
            const uniqueArticles = this.removeDuplicates(allArticles);
            const sortedArticles = uniqueArticles.sort((a, b) => 
                new Date(b.publishedAt) - new Date(a.publishedAt)
            );

            // Cache the results
            localStorage.setItem('cachedNews', JSON.stringify(sortedArticles));
            localStorage.setItem('lastNewsUpdate', new Date().toISOString());
            
            this.renderContent(sortedArticles);
            hideLoadingState();
            
            return sortedArticles;

        } catch (error) {
            console.error('Error fetching content:', error);
            this.renderFallbackContent();
            hideLoadingState();
        }
    }

    // Fetch from NewsAPI for major tech sites
    async fetchFromNewsAPI() {
        const domains = this.apiSources.join(',');
        const url = `https://newsapi.org/v2/everything?domains=${domains}&q=artificial+intelligence+OR+machine+learning+OR+AI&sortBy=publishedAt&pageSize=20&apiKey=${this.apiKey}`;
        
        try {
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.status === 'ok') {
                return data.articles.map(article => ({
                    title: article.title,
                    description: article.description,
                    url: article.url,
                    source: article.source.name,
                    publishedAt: article.publishedAt,
                    urlToImage: article.urlToImage,
                    category: 'news'
                }));
            }
        } catch (error) {
            console.error('NewsAPI error:', error);
        }
        
        return [];
    }

    // Fetch AI content from Reddit
    async fetchFromReddit() {
        const subreddits = ['MachineLearning', 'artificial', 'OpenAI', 'singularity', 'technology'];
        const allPosts = [];

        for (const subreddit of subreddits) {
            try {
                const response = await fetch(`https://www.reddit.com/r/${subreddit}/hot.json?limit=10`);
                const data = await response.json();
                
                const posts = data.data.children.map(post => ({
                    title: post.data.title,
                    description: post.data.selftext?.substring(0, 200) + '...' || 'Discussion on Reddit',
                    url: `https://reddit.com${post.data.permalink}`,
                    source: `r/${subreddit}`,
                    publishedAt: new Date(post.data.created_utc * 1000).toISOString(),
                    urlToImage: post.data.thumbnail !== 'self' ? post.data.thumbnail : null,
                    category: 'discussion'
                }));
                
                allPosts.push(...posts);
            } catch (error) {
                console.error(`Reddit ${subreddit} error:`, error);
            }
        }

        return allPosts;
    }

    // Fetch from Hacker News
    async fetchFromHackerNews() {
        try {
            const response = await fetch('https://hacker-news.firebaseio.com/v0/topstories.json');
            const storyIds = await response.json();
            
            // Get first 15 stories
            const storyPromises = storyIds.slice(0, 15).map(id =>
                fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(r => r.json())
            );
            
            const stories = await Promise.all(storyPromises);
            
            return stories
                .filter(story => story.title && story.url && 
                       story.title.toLowerCase().includes('ai') || 
                       story.title.toLowerCase().includes('artificial') ||
                       story.title.toLowerCase().includes('machine learning'))
                .map(story => ({
                    title: story.title,
                    description: 'Discussion on Hacker News',
                    url: story.url,
                    source: 'Hacker News',
                    publishedAt: new Date(story.time * 1000).toISOString(),
                    urlToImage: null,
                    category: 'tech'
                }));
        } catch (error) {
            console.error('Hacker News error:', error);
            return [];
        }
    }

    // Remove duplicate articles
    removeDuplicates(articles) {
        const seen = new Set();
        return articles.filter(article => {
            const key = article.title.toLowerCase().replace(/[^a-z0-9]/g, '');
            if (seen.has(key)) {
                return false;
            }
            seen.add(key);
            return true;
        });
    }

    // Render content to the page
    renderContent(articles) {
        const newsGrid = document.getElementById('news-grid');
        const contentGate = document.getElementById('content-gate');
        const isLoggedIn = localStorage.getItem('userToken');

        if (!isLoggedIn) {
            if (contentGate) contentGate.style.display = 'block';
            if (newsGrid) newsGrid.style.display = 'none';
            return;
        }

        if (contentGate) contentGate.style.display = 'none';
        if (newsGrid) {
            newsGrid.style.display = 'grid';
            
            const articlesHTML = articles.slice(0, 50).map((article, index) => `
                <div class="news-item" data-source="${article.source}" onclick="window.open('${article.url}', '_blank')">
                    ${article.urlToImage ? `<div class="news-image" style="background-image: url('${article.urlToImage}')"></div>` : ''}
                    <div class="news-content">
                        <div class="news-meta">
                            <span class="news-source">${article.source}</span>
                            <span class="news-time">${this.formatTime(article.publishedAt)}</span>
                            <span class="news-rank">#${index + 1}</span>
                        </div>
                        <h3 class="news-title">${article.title}</h3>
                        <p class="news-summary">${article.description || 'Click to read more...'}</p>
                        <div class="news-tags">
                            <span class="tag ${article.category}">${article.category}</span>
                            <span class="tag">AI</span>
                            ${this.isRecent(article.publishedAt) ? '<span class="tag live">LIVE</span>' : ''}
                        </div>
                    </div>
                </div>
            `).join('');

            newsGrid.innerHTML = articlesHTML;
            this.updateStats(articles.length);
        }
    }

    // Format time display
    formatTime(dateString) {
        const now = new Date();
        const articleDate = new Date(dateString);
        const diffMs = now - articleDate;
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const diffMins = Math.floor(diffMs / (1000 * 60));

        if (diffMins < 60) {
            return `${diffMins}m ago`;
        } else if (diffHours < 24) {
            return `${diffHours}h ago`;
        } else {
            return articleDate.toLocaleDateString();
        }
    }

    // Check if article is recent (last 2 hours)
    isRecent(dateString) {
        const now = new Date();
        const articleDate = new Date(dateString);
        const diffHours = (now - articleDate) / (1000 * 60 * 60);
        return diffHours <= 2;
    }

    // Update statistics display
    updateStats(articleCount) {
        const statsElement = document.getElementById('live-stats');
        if (statsElement) {
            statsElement.innerHTML = `
                <div class="stat">
                    <span class="stat-number">${articleCount}</span>
                    <span class="stat-label">Live Articles</span>
                </div>
                <div class="stat">
                    <span class="stat-number">50+</span>
                    <span class="stat-label">AI Sources</span>
                </div>
                <div class="stat">
                    <span class="stat-number">1h</span>
                    <span class="stat-label">Auto Refresh</span>
                </div>
            `;
        }

        // Update last updated time
        const lastUpdatedElement = document.getElementById('last-updated');
        if (lastUpdatedElement) {
            lastUpdatedElement.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
        }
    }

    // Fallback content when API fails
    renderFallbackContent() {
        if (this.cachedNews.length > 0) {
            this.renderContent(this.cachedNews);
        } else {
            const newsGrid = document.getElementById('news-grid');
            if (newsGrid) {
                newsGrid.innerHTML = `
                    <div class="error-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Unable to load live feed</h3>
                        <p>Please check your internet connection and try again.</p>
                        <button onclick="contentAggregator.fetchAllContent()" class="btn-primary">
                            <i class="fas fa-refresh"></i> Retry
                        </button>
                    </div>
                `;
            }
        }
    }
}

// Show/hide loading states
function showLoadingState() {
    const newsGrid = document.getElementById('news-grid');
    if (newsGrid) {
        newsGrid.innerHTML = `
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <h3>Fetching latest AI news from 50+ sources...</h3>
                <p>This may take a few moments</p>
            </div>
        `;
    }
}

function hideLoadingState() {
    // Loading state will be replaced by content
}

// Initialize content aggregator
const contentAggregator = new ContentAggregator();

// Auto-refresh every hour
setInterval(() => {
    contentAggregator.fetchAllContent();
}, 3600000); // 1 hour in milliseconds

// Initial load
document.addEventListener('DOMContentLoaded', () => {
    // Check if we should use cached data (less than 30 minutes old)
    const lastUpdate = localStorage.getItem('lastNewsUpdate');
    const thirtyMinutesAgo = new Date(Date.now() - 30 * 60 * 1000);
    
    if (lastUpdate && new Date(lastUpdate) > thirtyMinutesAgo) {
        // Use cached data
        const cachedNews = JSON.parse(localStorage.getItem('cachedNews') || '[]');
        if (cachedNews.length > 0) {
            contentAggregator.renderContent(cachedNews);
            return;
        }
    }
    
    // Fetch fresh data
    contentAggregator.fetchAllContent();
});
